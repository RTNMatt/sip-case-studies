# **SIP Call Park / Unpark Failures Caused by Delayed Media and Codec Negotiation Mismatch**

## **Environment Overview**

### **Infrastructure Components**

* IP desk phones (Polycom VVX series)

* Hosted PBX platform based on BroadWorks

* Enterprise SIP edge devices (Session Border Controllers)

* Microsoft Teams Direct Routing interconnect

* Public carrier SIP trunks

* RTP media relays within the provider core

### **Deployment Context**

* Phones registered to a hosted PBX service

* Calls entering the environment from both:

  * Traditional PSTN carriers

  * Microsoft Teams Direct Routing tenants

* Call park/unpark implemented using SIP feature access codes

* Media flows negotiated through multiple SBC layers

---

## **Problem Statement**

### **Observable Symptoms**

* Users could **park calls successfully**

* When attempting to **retrieve (unpark)**:

  * The retrieving phone briefly rang

  * The parked party heard silence or disconnect

  * The call was released shortly afterward

* Failures were consistently reproduced when calls originated from Microsoft Teams Direct Routing

* Calls from standard PSTN carriers did not reproduce the issue during testing

### **Impact**

* Inability to retrieve parked calls

* Dropped customer conversations

* Agents forced to redial callers

* Loss of confidence in call-handling features

---

## **Initial Hypotheses**

### 1. **SIP URI Encoding Issues**

**Why was it reasonable:**

* Feature access codes containing `#` appeared URL-encoded as `%23`

* RFC 3986 requires reserved characters to be escaped in SIP URIs

* URI encoding errors frequently break feature codes in SIP environments, especially when softkeys generate new INVITEs mid-dialog.

**Why was it insufficient:**

* Packet captures showed downstream systems accepting `sip:%2358@domain` and returning `200 OK`

* Park operations completed successfully at the signaling layer

* The same URI encoding was observed on calls that did not fail

* Failures occurred after media renegotiation, not during feature invocation

---

## 2. **Firewall / NAT RTP Blocking**

**Why was it reasonable:**

* Unpark operations triggered new RTP streams and media renegotiation.

* Blocked RTP ports could result in audio loss or forced call teardown.

* NAT traversal failures frequently surface during mid-call re-INVITEs.

* Customer-side firewalls commonly interfere with dynamically allocated RTP ports.

**Why was it insufficient:**

* SIP signaling completed normally through park and retrieval attempts.

* RTP port ranges observed in failing calls matched those used in successful calls.

* No ICMP unreachable responses or firewall drops were present in packet captures.

* Failures correlated to call origin rather than customer network topology.

---

## 3. **SBC Interoperability**

**Why was it reasonable:**

* Microsoft Teams Direct Routing integrations often require strict SDP compliance.

* Differences between early media and delayed media handling can cause renegotiation failures.

* SBC policies sometimes reject mid-dialog media changes.

* Interworking between cloud UC platforms and carrier SBCs is a common failure point.

**Why was it insufficient:**

* SBCs forwarded re-INVITEs without modification.

* Calls from non-Teams origins traversed the same SBC paths successfully.

* No SIP error responses or transport resets were generated by the SBC.

* SBC logs did not indicate policy enforcement or call rejection.

---

## **Investigation & Evidence**

### **Packet Capture Strategy**

* Captured full SIP dialogs at multiple network edges to allow end-to-end comparison of signaling paths and SDP behavior across all call legs for:

  * successful PSTN-originated park/unpark attempts

  * failed Teams-originated park/unpark attempts

---

### **Key SIP Observations**

#### **1\. Delayed Media During Park**

During the park operation, the Application Server generated re-INVITEs containing:

`c=IN IP4 0.0.0.0`  
`a=inactive`

This SDP signals:

* no RTP should be sent

* media streams temporarily suspended

* commonly used for hold or park

---

#### **2\. Codec Offer Changes**

Initial INVITEs from phones offered:

`m=audio <port> RTP/AVP 9 18 0`  
`a=rtpmap:9 G722/8000`  
`a=rtpmap:18 G729/8000`  
`a=rtpmap:0 PCMU/8000`

After park/unpark, BroadWorks re-INVITEs reduced media to:

`m=audio <port> RTP/AVP 0`

Only PCMU remained.

---

#### **3\. Re-INVITE on Retrieval**

When a user attempted to pick up a parked call:

* BroadWorks generated a new INVITE toward the retrieving endpoint

* SDP again contained:

  * `c=0.0.0.0`

  * `a=inactive`

* Followed by another offer attempting to restore media

Shortly after:

* one side transmitted a **BYE**

* no SIP error response preceded it

This strongly suggested:

* SDP negotiation completed

* but media setup failed internally

* triggering session cleanup by a control element

---

#### **4. URI Encoding Eliminated**

Due to `#` being a reserved character, `%23` properly sends in Request-URIs:

`INVITE sip:%2358@pbx.example.com`

* calls were properly routed to the park orbit

* the Application Server returned 200 OK confirming successful feature invocation

* dialogs progressed normally

This confirmed URI encoding was compliant and **not causal**.

---

## **Root Cause Analysis**

### **Root Cause**

The hosted PBX Application Server was configured for:

* **delayed media offering during park**

* **G.722 as preferred codec for call-to-trunk paths**

When Teams-originated calls were parked:

1. Media was placed on hold using `a=inactive`

2. On unpark, BroadWorks attempted to re-establish RTP

3. The re-INVITE codec offer conflicted with SBC expectations

4. Media anchoring could not be completed

5. The SBC or AS terminated the dialog with a BYE

### **Why Teams Calls Were Affected**

Calls entering via Teams:

* traversed additional interop SBCs

* enforced stricter SDP profiles

* differed in supported codecs

* did not tolerate delayed-media \+ codec switching mid-dialog

Traditional PSTN calls stayed inside the provider core and succeeded.

---

## **Resolution**

### **Changes Implemented**

* Adjusted codec preference so PCMU (G.711 Î¼-law) was prioritized for C2T paths, aligning Teams interop trunks with existing trunk profiles.

---

### **Why It Worked**

* The SBC and Application Server now presented a consistent codec set during park and retrieval.

* Teams Direct Routing no longer attempted to re-establish media using G.722 while the Application Server restricted offers to PCMU.

* Media negotiation completed cleanly during mid-dialog re-INVITEs.

* Sessions were no longer torn down by control elements after park retrieval.

Subsequent testing confirmed:

* repeated park/unpark success across Teams-originated calls

* no unexpected BYEs following retrieval

* stable two-way audio after re-establishment

---

## **Preventive Measures / Lessons Learned**

### **Standardize Mid-Dialog Codec Policy**

* Maintain consistent codec preference across all call states, including hold, park, transfer, and retrieval

* Avoid changing codec sets during mid-dialog re-INVITEs unless explicitly required

* Align Teams interop trunks and PSTN trunks to a common baseline codec (PCMU in this case) to reduce renegotiation risk

* Document codec policy differences between:

    * PSTN ingress

    * UC interconnects (Teams, Zoom, Webex)

    * Internal media anchors

---

### **Validate Park / Transfer Scenarios in Interop Testing**

* Treat park, unpark, blind transfer, consult transfer, and hold/resume as mandatory test cases for:

    * New trunk activations

    * SBC software upgrades

    * Codec-policy changes

    * Routing changes involving UC platforms

* Do not limit certification testing to basic call setup and teardown

* Include **mid-call feature invocation** when validating new carrier or cloud UC interconnects

---

### **Minimize Delayed-Media Usage Where Possible**

* Delayed media (`c=0.0.0.0`, `a=inactive`) should be applied consistently and only when required by platform design

* Where supported, prefer stable media anchoring instead of tearing down and rebuilding RTP paths during feature execution

* If delayed media is required:

    * Ensure SBCs explicitly support it

    * Confirm codec policies remain stable when media resumes

---

### **Interop Profiles Should Be Platform-Specific**

* Microsoft Teams Direct Routing trunks should use **dedicated SBC profiles** rather than generic PSTN profiles

* Profiles should explicitly define:

    * Supported codecs

    * SDP normalization rules

    * delayed-media handling

    * mid-dialog re-INVITE behavior

* Avoid relying on default SBC policies for UC interconnects.

---

### **Use Packet-Level Analysis Early**

* End-to-end SIP ladder captures across **all call legs** significantly reduced troubleshooting time.
* Comparing successful PSTN flows against failing Teams flows immediately highlighted:
  * SDP differences
  * codec reduction behavior
  * timing of BYEs
* Packet captures should be collected before engaging vendors whenever feature-level failures are reproducible.

---

### **Avoid Over-Focusing on URI Encoding or Signaling Artifacts**

* Although URI encoding and SIP formatting are common causes of feature failures, this case demonstrated that:
  * signaling may remain fully compliant
  * dialogs may complete successfully
  * failures can still occur due to **media-layer incompatibilities**
* Troubleshooting should expand quickly from SIP routing into **SDP and RTP anchoring behavior** once feature invocation succeeds.

---

### **Operational Monitoring Improvements**

Future detection of similar issues can be improved by:

* Alerting on:
  * mid-dialog BYEs following re-INVITEs
  * repeated `c=0.0.0.0` offers during feature execution
  * codec changes between initial INVITE and subsequent re-INVITEs
* Tracking park/unpark failure rates by ingress carrier or UC platform.
* Periodically auditing codec policies across trunk groups and interconnects.

---

### **Summary**

* Feature failures are often **media-plane problems disguised as signaling issues**.
* UC interconnects such as Teams are less tolerant of mid-call SDP changes than traditional PSTN paths.
* Codec consistency is critical during any call-control feature that temporarily suspends RTP.
* Preventive testing and standardized SBC profiles reduce production incidents far more effectively than reactive troubleshooting.